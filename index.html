<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Specter TGN Note Generator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px; /* Increased width for two columns */
            width: 100%;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #1a2b4d;
            border-bottom: 2px solid #e1e5e8;
            padding-bottom: 10px;
            margin-top: 0;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 1rem;
        }

        textarea {
            resize: vertical;
        }

        .company-row {
            display: flex;
            gap: 30px;
            padding: 20px;
            border: 1px solid #e1e5e8;
            border-radius: 8px;
            margin-bottom: 20px;
            position: relative; /* For the remove button */
            flex-wrap: wrap;
        }

        .input-column, .output-column {
            flex: 1;
            min-width: 350px;
        }

        .output-column {
            border-left: 1px solid #eee;
            padding-left: 30px;
        }

        @media (max-width: 800px) {
            .output-column {
                border-left: none;
                padding-left: 0;
                margin-top: 20px;
                border-top: 1px solid #eee;
                padding-top: 20px;
            }
        }

        .output-column h2 {
            margin-top: 0;
            color: #1a2b4d;
            font-size: 1.1em;
        }

        .tgn-result {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.95em;
            min-height: 150px;
            color: #888;
        }

        .row-status {
            margin-top: 10px;
            font-weight: bold;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .remove-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            font-weight: bold;
        }

            .remove-button:hover {
                color: #d9534f;
            }

        .controls {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        #addCompanyButton {
            background-color: #6c757d;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.2s;
            flex-grow: 0;
            width: auto;
        }

            #addCompanyButton:hover {
                background-color: #5a6268;
            }

        #generateAllButton {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.2s;
            flex-grow: 1;
        }

            #generateAllButton:hover {
                background-color: #0056b3;
            }

            #generateAllButton:disabled {
                background-color: #0056b3;
                cursor: not-allowed;
            }

        #globalStatus {
            margin-top: 20px;
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        .status-error {
            color: #d9534f;
            background-color: #f2dede;
        }

        .status-success {
            color: #5cb85c;
            background-color: #dff0d8;
        }

        .status-loading {
            color: #31708f;
            background-color: #d9edf7;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Specter TGN Note Generator</h1>

        <div class="input-group">
            <label for="userInitials">Your Initials</label>
            <input type="text" id="userInitials" placeholder="e.g., LS">
        </div>

        <div id="companiesContainer">
            <!-- Company rows will be inserted here by JavaScript -->
        </div>

        <div class="controls">
            <button id="addCompanyButton">+ Add Another Company</button>
            <button id="generateAllButton">Generate All TGN Notes</button>
        </div>

        <div id="globalStatus"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const companiesContainer = document.getElementById('companiesContainer');
            const addCompanyButton = document.getElementById('addCompanyButton');
            const generateAllButton = document.getElementById('generateAllButton');
            const userInitialsInput = document.getElementById('userInitials');
            const globalStatus = document.getElementById('globalStatus');
            let companyCounter = 0;

            function showGlobalStatus(message, type) {
                globalStatus.textContent = message;
                globalStatus.className = `status-${type}`;
            }

            function extractCompanyId(url) {
                const match = url.match(/\/feed\/([a-f0-9]+)/);
                return match ? match[1] : null;
            }

            function addCompanyRow() {
                companyCounter++;
                const row = document.createElement('div');
                row.className = 'company-row';
                row.dataset.companyId = companyCounter;

                row.innerHTML = `
                    <div class="input-column">
                        <div class="input-group">
                            <label for="specterUrl-${companyCounter}">Specter Company URL</label>
                            <input type="text" id="specterUrl-${companyCounter}" class="specter-url" placeholder="e.g., https://app.tryspecter.com/signals/company/feed/...">
                        </div>
                        <div class="input-group">
                            <label for="growthMetrics-${companyCounter}">Growth Metrics (Optional)</label>
                            <textarea id="growthMetrics-${companyCounter}" class="growth-metrics" rows="4" placeholder="e.g., 19% MoM growth, $217k ARR, 27 paying customers..."></textarea>
                        </div>
                    </div>
                    <div class="output-column">
                        <h2>Generated TGN Note</h2>
                        <pre class="tgn-result">Awaiting generation...</pre>
                        <div class="row-status"></div>
                    </div>
                    <button class="remove-button" title="Remove Company">×</button>
                `;

                companiesContainer.appendChild(row);

                row.querySelector('.remove-button').addEventListener('click', () => {
                    row.remove();
                });
            }

            async function processCompanyRow(rowElement, initials) {
                const urlInput = rowElement.querySelector('.specter-url');
                const growthMetricsInput = rowElement.querySelector('.growth-metrics');
                const resultEl = rowElement.querySelector('.tgn-result');
                const statusEl = rowElement.querySelector('.row-status');

                const showRowStatus = (message, type) => {
                    statusEl.textContent = message;
                    statusEl.className = `row-status status-${type}`;
                };

                try {
                    showRowStatus('', '');
                    resultEl.textContent = '';
                    resultEl.style.color = '#888';

                    const url = urlInput.value.trim();
                    if (!url) {
                        showRowStatus('Skipped: URL is required.', 'error');
                        return;
                    }
                    const companyId = extractCompanyId(url);
                    if (!companyId) {
                        throw new Error('Could not parse Company ID from the URL.');
                    }
                    const growthMetrics = growthMetricsInput.value.trim();

                    showRowStatus(`Fetching data for ID: ${companyId}...`, 'loading');

                    const companyResponse = await fetch(`/api/specter?id=${companyId}`);
                    if (!companyResponse.ok) {
                        const errorData = await companyResponse.json();
                        throw new Error(`Company Fetch Failed: ${errorData.error || companyResponse.statusText}`);
                    }
                    const companyData = await companyResponse.json();

                    showRowStatus('Fetching founder data...', 'loading');
                    const peopleResponse = await fetch(`/api/people?companyId=${companyId}`);
                    if (!peopleResponse.ok) {
                        const errorData = await peopleResponse.json();
                        throw new Error(`Founder Fetch Failed: ${errorData.error || peopleResponse.statusText}`);
                    }
                    const founderData = await peopleResponse.json();

                    showRowStatus('Generating TGN Note...', 'loading');
                    const tgnResponse = await fetch('/api/generate-tgn', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initials, growthMetrics, companyData, founderData }),
                    });

                    if (!tgnResponse.ok) {
                        const errorData = await tgnResponse.json();
                        throw new Error(`TGN Generation Failed: ${errorData.error || tgnResponse.statusText}`);
                    }
                    const tgnNote = await tgnResponse.text();

                    showRowStatus('Success! TGN Note generated.', 'success');
                    resultEl.textContent = tgnNote;
                    resultEl.style.color = '#333';

                } catch (error) {
                    console.error('Error processing row:', rowElement.dataset.companyId, error);
                    showRowStatus(`Error: ${error.message}`, 'error');
                    resultEl.textContent = 'Generation failed. See error message above.';
                    resultEl.style.color = '#d9534f';
                }
            }

            addCompanyButton.addEventListener('click', addCompanyRow);

            generateAllButton.addEventListener('click', async () => {
                showGlobalStatus('', '');

                const initials = userInitialsInput.value.trim().toUpperCase();
                if (!initials) {
                    showGlobalStatus('Error: Your initials are required to generate notes.', 'error');
                    return;
                }

                const companyRows = document.querySelectorAll('.company-row');
                if (companyRows.length === 0) {
                    showGlobalStatus('Please add at least one company to generate a note.', 'error');
                    return;
                }

                showGlobalStatus(`Processing ${companyRows.length} companies...`, 'loading');
                generateAllButton.disabled = true;
                generateAllButton.textContent = 'Processing...';

                const processingPromises = Array.from(companyRows).map(row => processCompanyRow(row, initials));

                await Promise.all(processingPromises);

                generateAllButton.disabled = false;
                generateAllButton.textContent = 'Generate All TGN Notes';

                let errorCount = 0;
                document.querySelectorAll('.row-status').forEach(statusEl => {
                    if (statusEl.classList.contains('status-error')) {
                        errorCount++;
                    }
                });

                if (errorCount > 0) {
                    showGlobalStatus(`Processing complete. ${errorCount} of ${companyRows.length} companies failed.`, 'error');
                } else {
                    showGlobalStatus(`Success! All ${companyRows.length} notes generated.`, 'success');
                }
            });

            addCompanyRow();
        });
    </script>

</body>
</html>